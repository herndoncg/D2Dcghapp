<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CGH Field App</title>
  <meta name="description" content="CGH Door-to-Door Field App (single-file production-ready front-end)." />

  <!--
    ‚úÖ THIS FILE IS NOW "REAL" (NOT DEMO):
    - Firebase Auth (email/password)
    - Firestore (pins, quotes, services, addons, resources, photos metadata, users)
    - Firebase Storage (photo uploads)
    - Google Maps JS API (real map + markers)
    - Stripe checkout via serverless endpoint (Netlify Functions recommended)

    YOU MUST DO THESE 4 THINGS:

    1) Firebase Project
       - Enable Authentication (Email/Password)
       - Create Firestore Database
       - Enable Storage
       - Create a Web App and copy its config into FIREBASE_CONFIG below

    2) Firestore Security Rules (IMPORTANT)
       - Use rules to ensure:
         ‚Ä¢ reps can only read/write their own pins/quotes/photos
         ‚Ä¢ admins can read/write everything + pricing collections
       - I can generate the exact rules file when you‚Äôre ready.

    3) Google Maps API Key
       - Enable Maps JavaScript API (+ Places API recommended)
       - Restrict key to your domain (HTTP referrers)
       - Put it in GOOGLE_MAPS_API_KEY below

    4) Stripe Serverless
       - Create serverless endpoints:
         ‚Ä¢ /.netlify/functions/createCheckoutSession
         ‚Ä¢ /.netlify/functions/stripeWebhook  (optional but recommended)
       - Put STRIPE_SECRET_KEY + STRIPE_WEBHOOK_SECRET in Netlify env vars
       - The front-end calls createCheckoutSession and redirects to Stripe.

    DEPLOYMENT PATHS
      Option A (recommended): https://cghoperations.com/d2d
        - Put this file at: /d2d/index.html in your CGH website repo

      Option B: https://app.cghoperations.com
        - New Netlify site + subdomain

    NOTE: You cannot do Stripe "for real" with ONLY static HTML.
          The secret key must stay server-side (functions).
  -->

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#111f38;
      --text:#e8eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.10);
      --accent:#2f7cf6;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#60a5fa;
      --radius:16px;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:radial-gradient(1200px 900px at 20% 0%, rgba(47,124,246,.22), transparent 60%),
                 radial-gradient(1200px 900px at 90% 10%, rgba(34,197,94,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(17,31,56,.85), rgba(15,26,46,.85));
      box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:10;backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(135deg, rgba(47,124,246,.95), rgba(96,165,250,.6));
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;font-weight:800;letter-spacing:.5px;
    }
    .brand h1{font-size:14px;line-height:1.1;margin:0}
    .brand p{margin:0;color:var(--muted);font-size:12px}

    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media (max-width: 920px){.row{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(17,31,56,.78), rgba(15,26,46,.85));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .card .hd .title{font-weight:700;font-size:14px}
    .card .bd{padding:16px}

    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.04)
    }

    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);padding:10px 12px;border-radius:12px;
      font-weight:650;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.20)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(47,124,246,.22);border-color:rgba(47,124,246,.55)}
    .btn.primary:hover{background:rgba(47,124,246,.28)}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.45)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:520px){.grid2{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .in{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);outline:none;
    }
    .in:focus{border-color:rgba(47,124,246,.7);box-shadow:0 0 0 3px rgba(47,124,246,.18)}
    .hint{font-size:12px;color:var(--muted);line-height:1.4}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);cursor:pointer;color:var(--muted);font-weight:650;font-size:12px}
    .tab.active{background:rgba(47,124,246,.20);border-color:rgba(47,124,246,.55);color:var(--text)}

    .map{height:440px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);position:relative;overflow:hidden}
    #mapCanvas{height:100%;width:100%}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.14);
      border-radius:14px;padding:12px;
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between
    }
    .item .left{min-width:0}
    .item .name{font-weight:800;margin:0 0 2px;font-size:13px}
    .item .meta{font-size:12px;color:var(--muted);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .badge{font-size:11px;padding:5px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);display:inline-flex;align-items:center;gap:6px}
    .b-new{background:rgba(96,165,250,.14);border-color:rgba(96,165,250,.35)}
    .b-quoted{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35)}
    .b-follow{background:rgba(168,85,247,.14);border-color:rgba(168,85,247,.35)}
    .b-booked{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.32)}
    .b-no{background:rgba(148,163,184,.12);border-color:rgba(148,163,184,.28)}
    .b-not{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.28)}
    .b-dnk{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}

    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.split{grid-template-columns:1fr}}

    .totals{border-top:1px solid var(--line);margin-top:12px;padding-top:12px}
    .totals .r{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin:6px 0}
    .totals .r strong{font-size:14px}

    .footerbar{
      position:sticky;bottom:12px;margin-top:16px;
      border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(15,26,46,.88);
      box-shadow:var(--shadow);
      padding:10px 10px;display:flex;gap:8px;justify-content:space-between;align-items:center
    }
    .footerbar .left{display:flex;gap:8px;flex-wrap:wrap}

    .notice{border:1px solid rgba(47,124,246,.35);background:rgba(47,124,246,.12);border-radius:14px;padding:12px;color:#dbe8ff}
    .notice strong{display:block;margin-bottom:4px}

    .hidden{display:none !important}

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter: blur(6px);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(820px, 100%);border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg, rgba(17,31,56,.92), rgba(15,26,46,.96));border-radius:18px;box-shadow:0 30px 90px rgba(0,0,0,.55);overflow:hidden}
    .modal .mh{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal .mb{padding:16px}
    .modal .mh .t{font-weight:900}

    .kbd{font-family:var(--mono);font-size:12px;padding:3px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#cfe0ff}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .admin-only{display:none}

    .toast{position:fixed;right:16px;bottom:16px;max-width:420px;z-index:9999}
    .toast .titem{border:1px solid rgba(255,255,255,.16);background:rgba(15,26,46,.92);box-shadow:0 12px 30px rgba(0,0,0,.45);border-radius:14px;padding:12px;margin-top:10px}
    .toast .titem strong{display:block;margin-bottom:4px}

    .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.35);border-top-color:rgba(255,255,255,.9);border-radius:999px;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">CGH</div>
        <div>
          <h1>CGH Field App <span class="pill" id="envPill">Live</span></h1>
          <p id="userLine">Checking session‚Ä¶</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnOpenSetup">‚öôÔ∏è Setup</button>
        <button class="btn danger hidden" id="btnLogout">Log out</button>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="viewLogin" class="row" style="margin-top:16px">
      <div class="card">
        <div class="hd"><div class="title">Login</div><span class="pill">Rep or Admin</span></div>
        <div class="bd">
          <div class="notice" style="margin-bottom:12px">
            <strong>Real login is enabled.</strong>
            Your admin user is determined by Firestore role (or the ADMIN_UIDS fallback in config).
          </div>

          <div class="grid2">
            <div>
              <label>Email</label>
              <input class="in" id="loginEmail" placeholder="name@company.com" />
            </div>
            <div>
              <label>Password</label>
              <input class="in" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap">
            <button class="btn primary" id="btnLogin">Login</button>
            <button class="btn" id="btnForgot">Forgot password</button>
            <span class="small" id="loginState"></span>
          </div>

          <div class="hr"></div>
          <div class="hint">
            <div><strong>Admin note</strong></div>
            <div>‚Ä¢ You create rep accounts in Firebase Auth (console) OR we add an Admin-only ‚ÄúInvite User‚Äù function later.</div>
            <div>‚Ä¢ Roles are stored at <span class="kbd">users/{uid}</span> with field <span class="kbd">role</span> = <span class="kbd">admin</span> or <span class="kbd">rep</span>.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="title">What this app does</div><span class="pill">Rep-proof</span></div>
        <div class="bd">
          <div class="list">
            <div class="item">
              <div class="left">
                <div class="name">üó∫ Map + Pins</div>
                <p class="meta">Drop pins, track statuses, set follow-ups.</p>
              </div>
              <span class="badge b-new">Live</span>
            </div>
            <div class="item">
              <div class="left">
                <div class="name">üìã Quote Builder</div>
                <p class="meta">Services + quantities + minimums + add-ons.</p>
              </div>
              <span class="badge b-quoted">Live</span>
            </div>
            <div class="item">
              <div class="left">
                <div class="name">üí≥ Payments</div>
                <p class="meta">Deposit or full pay (Stripe Checkout via functions).</p>
              </div>
              <span class="badge b-follow">Live (requires functions)</span>
            </div>
            <div class="item">
              <div class="left">
                <div class="name">üì∏ Photos + üìö Resources</div>
                <p class="meta">Upload before/after and view training docs.</p>
              </div>
              <span class="badge b-no">Live</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="viewApp" class="hidden" style="margin-top:16px">

      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="map">üó∫ Map</button>
        <button class="tab" data-tab="quote">üìã Quote</button>
        <button class="tab" data-tab="photos">üì∏ Photos</button>
        <button class="tab" data-tab="resources">üìö Resources</button>
        <button class="tab admin-only" data-tab="admin">‚öôÔ∏è Admin</button>
      </div>

      <div class="row">

        <!-- LEFT MAIN -->
        <div class="card">
          <div class="hd">
            <div class="title" id="panelTitle">Map / Leads</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="pill" id="modePill">Rep View</span>
              <button class="btn" id="btnAddPin">‚ûï Add Pin</button>
            </div>
          </div>
          <div class="bd" id="panelBody">

            <!-- MAP TAB -->
            <div class="tabpane" id="tab-map">
              <div class="grid2" style="margin-bottom:12px">
                <div>
                  <label>Search Address</label>
                  <input class="in" id="searchAddress" placeholder="123 Main St, Longview TX" />
                </div>
                <div>
                  <label>Filter Pins</label>
                  <select class="in" id="filterStatus">
                    <option value="">All statuses</option>
                    <option value="New Lead">New Lead</option>
                    <option value="Quoted">Quoted</option>
                    <option value="Follow-Up Needed">Follow-Up Needed</option>
                    <option value="Booked">Booked</option>
                    <option value="No Answer">No Answer</option>
                    <option value="Not Interested">Not Interested</option>
                    <option value="Do Not Knock">Do Not Knock</option>
                  </select>
                </div>
              </div>

              <div class="map" id="map">
                <div id="mapCanvas"></div>
              </div>

              <div class="notice" style="margin-top:12px">
                <strong>Field Flow</strong>
                Drop a pin ‚Üí set status ‚Üí add notes ‚Üí create quote ‚Üí collect deposit.
              </div>
            </div>

            <!-- QUOTE TAB -->
            <div class="tabpane hidden" id="tab-quote">
              <div class="split">
                <div>
                  <div class="title" style="margin-bottom:8px">Customer</div>
                  <div class="grid2">
                    <div>
                      <label>Name</label>
                      <input class="in" id="qCustomer" placeholder="Customer name" />
                    </div>
                    <div>
                      <label>Phone</label>
                      <input class="in" id="qPhone" placeholder="903-___-____" />
                    </div>
                  </div>
                  <div style="margin-top:10px">
                    <label>Address</label>
                    <input class="in" id="qAddress" placeholder="Street, City, State" />
                  </div>

                  <div class="hr"></div>

                  <div class="title" style="margin-bottom:8px">Services</div>
                  <div class="hint" style="margin-bottom:8px">Select a service, enter quantity, it auto-calculates. Minimums are enforced.</div>

                  <div class="grid2">
                    <div>
                      <label>Service</label>
                      <select class="in" id="svcSelect"></select>
                    </div>
                    <div>
                      <label>Quantity</label>
                      <input class="in" id="svcQty" type="number" min="0" step="0.01" placeholder="e.g., 1800" />
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                    <button class="btn primary" id="btnAddService">Add Service</button>
                    <button class="btn" id="btnClearQuote">Clear</button>
                  </div>

                  <div class="hr"></div>

                  <div class="title" style="margin-bottom:8px">Add-ons / Extras</div>
                  <div class="grid2">
                    <div>
                      <label>Preset Add-on</label>
                      <select class="in" id="addonSelect"></select>
                    </div>
                    <div>
                      <label>Amount ($)</label>
                      <input class="in" id="addonAmt" type="number" min="0" step="0.01" placeholder="auto" />
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                    <button class="btn" id="btnAddAddon">Add Preset</button>
                  </div>

                  <div class="grid2" style="margin-top:10px">
                    <div>
                      <label>Custom Add-on Description</label>
                      <input class="in" id="customDesc" placeholder="e.g., Heavy algae on north side" />
                    </div>
                    <div>
                      <label>Custom Add-on Amount ($)</label>
                      <input class="in" id="customAmt" type="number" min="0" step="0.01" placeholder="e.g., 75" />
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                    <button class="btn" id="btnAddCustom">Add Custom</button>
                  </div>

                </div>

                <div>
                  <div class="title" style="margin-bottom:8px">Quote Summary</div>
                  <div class="card" style="box-shadow:none">
                    <div class="bd">
                      <div id="quoteLines" class="list"></div>

                      <div class="totals">
                        <div class="r"><span class="small">Subtotal</span><span id="subTotal">$0.00</span></div>
                        <div class="r"><span class="small">Tax</span><span class="small" id="taxLine">(optional)</span></div>
                        <div class="r"><strong>Total</strong><strong id="grandTotal">$0.00</strong></div>
                      </div>

                      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                        <button class="btn primary" id="btnSaveQuote">Save Quote</button>
                        <button class="btn" id="btnDeposit">Collect Deposit</button>
                        <button class="btn" id="btnPayFull">Pay in Full</button>
                      </div>

                      <div class="hint" style="margin-top:10px">
                        Payments are live if your serverless function is deployed.
                      </div>
                    </div>
                  </div>

                  <div class="notice" style="margin-top:12px">
                    <strong>Admin-controlled pricing</strong>
                    Reps only choose service + quantity + add-ons.
                  </div>
                </div>

              </div>
            </div>

            <!-- PHOTOS TAB -->
            <div class="tabpane hidden" id="tab-photos">
              <div class="notice" style="margin-bottom:12px">
                <strong>Photo Upload</strong>
                Uploads go to Firebase Storage and the metadata is stored in Firestore.
              </div>

              <div class="grid2">
                <div>
                  <label>Attach to</label>
                  <select class="in" id="photoAttach">
                    <option value="General">General</option>
                    <option value="Pin">Pin</option>
                    <option value="Quote">Quote</option>
                  </select>
                </div>
                <div>
                  <label>Before/After</label>
                  <select class="in" id="photoType">
                    <option value="Before">Before</option>
                    <option value="After">After</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <div style="margin-top:10px">
                <label>Notes</label>
                <input class="in" id="photoNotes" placeholder="e.g., driveway oil stain, north corner" />
              </div>

              <div style="margin-top:10px">
                <label>Select file</label>
                <input class="in" id="photoFile" type="file" accept="image/*" />
              </div>

              <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                <button class="btn primary" id="btnUploadPhoto">Upload</button>
                <button class="btn" id="btnClearPhotos">Clear List (admin)</button>
              </div>

              <div class="hr"></div>
              <div class="title" style="margin-bottom:8px">Recent Uploads</div>
              <div id="photoList" class="list"></div>
            </div>

            <!-- RESOURCES TAB -->
            <div class="tabpane hidden" id="tab-resources">
              <div class="notice" style="margin-bottom:12px">
                <strong>Resources Library</strong>
                Store D2D scripts, objection handling, pricing notes, and portfolio examples.
              </div>

              <div class="grid2">
                <div>
                  <label>Category</label>
                  <select class="in" id="resCat">
                    <option>D2D Scripts</option>
                    <option>Objection Handling</option>
                    <option>Pricing Guidelines</option>
                    <option>Portfolio / Examples</option>
                  </select>
                </div>
                <div>
                  <label>Title</label>
                  <input class="in" id="resTitle" placeholder="e.g., Top 10 Objections ‚Äî Quick Hits" />
                </div>
              </div>
              <div style="margin-top:10px">
                <label>Content / Link</label>
                <input class="in" id="resBody" placeholder="Paste a note or a link to a PDF" />
              </div>
              <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                <button class="btn primary" id="btnAddRes">Add Resource</button>
                <button class="btn" id="btnClearRes">Clear Library (admin)</button>
              </div>

              <div class="hr"></div>
              <div class="title" style="margin-bottom:8px">Library</div>
              <div id="resList" class="list"></div>
            </div>

            <!-- ADMIN TAB -->
            <div class="tabpane hidden" id="tab-admin">
              <div class="notice" style="margin-bottom:12px">
                <strong>Admin Control Panel</strong>
                Update services, rates, minimums, and preset add-ons. Reps can‚Äôt change pricing.
              </div>

              <div class="split">
                <div>
                  <div class="title" style="margin-bottom:8px">Services</div>
                  <div class="grid2">
                    <div>
                      <label>Service Name</label>
                      <input class="in" id="aSvcName" placeholder="e.g., House Wash" />
                    </div>
                    <div>
                      <label>Unit Type</label>
                      <select class="in" id="aSvcUnit">
                        <option value="sqft">sqft</option>
                        <option value="linear_ft">linear ft</option>
                        <option value="each">each</option>
                        <option value="hour">hour</option>
                      </select>
                    </div>
                  </div>
                  <div class="grid2" style="margin-top:10px">
                    <div>
                      <label>Rate ($ per unit)</label>
                      <input class="in" id="aSvcRate" type="number" min="0" step="0.0001" placeholder="e.g., 0.18" />
                    </div>
                    <div>
                      <label>Minimum ($)</label>
                      <input class="in" id="aSvcMin" type="number" min="0" step="0.01" placeholder="e.g., 249" />
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                    <button class="btn primary" id="btnAdminAddSvc">Add/Update Service</button>
                    <button class="btn" id="btnAdminResetSvc">Reset Defaults</button>
                  </div>
                  <div class="hr"></div>
                  <div id="svcAdminList" class="list"></div>
                </div>

                <div>
                  <div class="title" style="margin-bottom:8px">Preset Add-ons</div>
                  <div class="grid2">
                    <div>
                      <label>Add-on Name</label>
                      <input class="in" id="aAddName" placeholder="e.g., Heavy Buildup" />
                    </div>
                    <div>
                      <label>Amount ($)</label>
                      <input class="in" id="aAddAmt" type="number" min="0" step="0.01" placeholder="e.g., 75" />
                    </div>
                  </div>
                  <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                    <button class="btn primary" id="btnAdminAddAddon">Add/Update Add-on</button>
                    <button class="btn" id="btnAdminResetAddon">Reset Defaults</button>
                  </div>
                  <div class="hr"></div>
                  <div id="addonAdminList" class="list"></div>

                  <div class="hr"></div>
                  <div class="title" style="margin-bottom:8px">Users (roles)</div>
                  <div class="hint">
                    Roles live in Firestore at <span class="kbd">users/{uid}</span>.
                    <div style="margin-top:6px">Admin can edit those docs in Firebase console right now (fastest). We can add a UI editor later.</div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div class="card">
          <div class="hd">
            <div class="title">Leads / Pins</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="pill" id="pinCount">0 pins</span>
              <button class="btn" id="btnExport">Export</button>
            </div>
          </div>
          <div class="bd">
            <div class="hint" style="margin-bottom:10px">Tap a pin to edit, set follow-up, or create a quote.</div>
            <div id="pinList" class="list"></div>
          </div>
        </div>

      </div>

      <div class="footerbar">
        <div class="left">
          <button class="btn" id="btnQuickNew">New Lead</button>
          <button class="btn" id="btnQuickFollow">Follow-Ups</button>
          <button class="btn" id="btnQuickBooked">Booked</button>
        </div>
        <div class="small" id="footNote">Live: Firebase ‚Ä¢ Maps ‚Ä¢ Stripe</div>
      </div>

    </div>

  </div>

  <!-- PIN MODAL -->
  <div class="modal-back" id="pinModalBack">
    <div class="modal">
      <div class="mh">
        <div>
          <div class="t" id="pinModalTitle">Add Pin</div>
          <div class="small" id="pinModalSub">Track a lead and set follow-ups.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="btnPinDelete">Delete</button>
          <button class="btn" id="btnPinClose">‚úï</button>
        </div>
      </div>
      <div class="mb">
        <div class="grid2">
          <div>
            <label>Address</label>
            <input class="in" id="pAddress" placeholder="123 Main St, Longview TX" />
          </div>
          <div>
            <label>Status</label>
            <select class="in" id="pStatus">
              <option>New Lead</option>
              <option>Quoted</option>
              <option>Follow-Up Needed</option>
              <option>Booked</option>
              <option>No Answer</option>
              <option>Not Interested</option>
              <option>Do Not Knock</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Customer Name (optional)</label>
            <input class="in" id="pName" placeholder="Customer name" />
          </div>
          <div>
            <label>Phone (optional)</label>
            <input class="in" id="pPhone" placeholder="903-___-____" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Notes</label>
          <input class="in" id="pNotes" placeholder="Gate code, dog, preferred contact time, etc." />
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Follow-up Date (optional)</label>
            <input class="in" id="pFollowDate" type="date" />
          </div>
          <div>
            <label>Follow-up Time (optional)</label>
            <input class="in" id="pFollowTime" type="time" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Latitude</label>
            <input class="in" id="pLat" type="number" step="0.000001" placeholder="auto" />
          </div>
          <div>
            <label>Longitude</label>
            <input class="in" id="pLng" type="number" step="0.000001" placeholder="auto" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
          <button class="btn primary" id="btnPinSave">Save Pin</button>
          <button class="btn" id="btnPinToQuote">Create Quote From Pin</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Pins are stored in Firestore and keyed by your user id.
        </div>
      </div>
    </div>
  </div>

  <!-- SETUP MODAL -->
  <div class="modal-back" id="setupBack">
    <div class="modal">
      <div class="mh">
        <div>
          <div class="t">Setup (Keys / Endpoints)</div>
          <div class="small">These are the only placeholders you must fill.</div>
        </div>
        <button class="btn" id="btnSetupClose">‚úï</button>
      </div>
      <div class="mb">
        <div class="notice" style="margin-bottom:12px">
          <strong>Paste your keys in the CONFIG section inside this file.</strong>
          If you deploy on Netlify, keep Stripe keys in environment variables (functions), not in this HTML.
        </div>

        <div class="hint">
          <div><strong>Required</strong></div>
          <div>‚Ä¢ <span class="kbd">FIREBASE_CONFIG</span></div>
          <div>‚Ä¢ <span class="kbd">GOOGLE_MAPS_API_KEY</span></div>
          <div>‚Ä¢ Stripe Functions Endpoint: <span class="kbd">/.netlify/functions/createCheckoutSession</span></div>
        </div>

        <div class="hr"></div>

        <div class="hint">
          <div><strong>Bootstrap Admin</strong></div>
          <div>Put your Firebase Auth UID into <span class="kbd">ADMIN_UIDS</span> in config. That guarantees you‚Äôre admin even before roles exist.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    // ============================
    // CONFIG (YOU MUST FILL THESE)
    // ============================

    // 1) Firebase Web App config (Project settings ‚Üí Your apps ‚Üí Web app)
    const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAVAyhqR36mvJ-eg2ypKGoIVDwX7Nr18SQ",
  authDomain: "cgh-d2d-app.firebaseapp.com",
  projectId: "cgh-d2d-app",
  storageBucket: "cgh-d2d-app.firebasestorage.app",
  messagingSenderId: "174411509818",
  appId: "1:174411509818:web:c0c6d30d82c84ffb110503"
};

    // 2) Your Google Maps API key
    const GOOGLE_MAPS_API_KEY = "PASTE_ME";

    // 3) Stripe Checkout serverless endpoint (Netlify Functions recommended)
    //    Must return JSON: { url: "https://checkout.stripe.com/..." }
    const STRIPE_CREATE_SESSION_URL = "/.netlify/functions/createCheckoutSession";

    // 4) Admin bootstrap (put YOUR Firebase auth UID here)
    //    This guarantees you can access admin panel even before roles are set.
    const ADMIN_UIDS = [
      // "YOUR_UID_HERE"
    ];

    // Optional: default map center
    const DEFAULT_CENTER = { lat: 32.5007, lng: -94.7405 }; // Longview-ish

    // Optional: deposit rules
    const DEPOSIT_MODE = "percent"; // "percent" or "flat"
    const DEPOSIT_PERCENT = 0.30;
    const DEPOSIT_FLAT = 100;

    // ============================
    // IMPORTS
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ============================
    // DOM HELPERS
    // ============================
    const $ = (id)=>document.getElementById(id);

    function toast(title, msg){
      const t = $('toast');
      const el = document.createElement('div');
      el.className='titem';
      el.innerHTML = `<strong>${escapeHtml(title)}</strong><div class="small">${escapeHtml(msg)}</div>`;
      t.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 4200);
    }

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>\"]/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'
      }[c]));
    }

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function money(n){
      const v = Number(n||0);
      return v.toLocaleString(undefined,{style:'currency',currency:'USD'});
    }

    function unitLabel(unit){
      if(unit==='sqft') return 'sqft';
      if(unit==='linear_ft') return 'linear ft';
      if(unit==='each') return 'each';
      if(unit==='hour') return 'hour';
      return unit;
    }

    function badgeClass(status){
      switch(status){
        case 'New Lead': return 'b-new';
        case 'Quoted': return 'b-quoted';
        case 'Follow-Up Needed': return 'b-follow';
        case 'Booked': return 'b-booked';
        case 'No Answer': return 'b-no';
        case 'Not Interested': return 'b-not';
        case 'Do Not Knock': return 'b-dnk';
        default: return 'b-no';
      }
    }

    // ============================
    // FIREBASE INIT
    // ============================
    const fbApp = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const storage = getStorage(fbApp);

    // ============================
    // GOOGLE MAPS LOADER
    // ============================
    let map = null;
    let geocoder = null;
    let markers = new Map(); // pinId -> marker

    function loadGoogleMaps(){
      return new Promise((resolve, reject)=>{
        if(window.google?.maps){ resolve(); return; }
        if(!GOOGLE_MAPS_API_KEY || GOOGLE_MAPS_API_KEY==='PASTE_ME'){
          reject(new Error('Missing GOOGLE_MAPS_API_KEY')); return;
        }
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}&libraries=places&v=weekly`;
        s.async = true;
        s.onload = ()=>resolve();
        s.onerror = ()=>reject(new Error('Failed to load Google Maps script'));
        document.head.appendChild(s);
      });
    }

    function statusColor(status){
      // Marker hue approximation
      switch(status){
        case 'New Lead': return '#60a5fa';
        case 'Quoted': return '#f59e0b';
        case 'Follow-Up Needed': return '#a855f7';
        case 'Booked': return '#22c55e';
        case 'No Answer': return '#94a3b8';
        case 'Not Interested': return '#ef4444';
        case 'Do Not Knock': return '#ef4444';
        default: return '#94a3b8';
      }
    }

    function makeMarkerIcon(color){
      // Simple SVG pin icon
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24">
          <path fill="${color}" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
        </svg>`;
      return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        scaledSize: new google.maps.Size(28, 28),
        anchor: new google.maps.Point(14, 28)
      };
    }

    async function initMap(){
      await loadGoogleMaps();
      map = new google.maps.Map($('mapCanvas'), {
        center: DEFAULT_CENTER,
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
      geocoder = new google.maps.Geocoder();

      // Address autocomplete
      try{
        const input = $('searchAddress');
        const ac = new google.maps.places.Autocomplete(input, { fields: ['geometry','formatted_address','name'] });
        ac.addListener('place_changed', ()=>{
          const place = ac.getPlace();
          if(place?.geometry?.location){
            map.panTo(place.geometry.location);
            map.setZoom(16);
          }
        });
      } catch { /* Places optional */ }

      // Map click: quick pin
      map.addListener('click', (e)=>{
        openPinModal({ lat: e.latLng.lat(), lng: e.latLng.lng(), status: 'New Lead' }, true);
      });
    }

    // ============================
    // APP STATE
    // ============================
    let state = {
      user: null,
      role: 'rep',
      tab: 'map',
      editingPinId: null,
      pins: [],
      services: [],
      addons: [],
      resources: [],
      photos: [],
      quote: {
        lines: [],
        addons: [],
        customer: {name:'', phone:'', address:''},
        pinId: null
      }
    };

    // Subscriptions (unsubscribe functions)
    let unsubPins = null;
    let unsubServices = null;
    let unsubAddons = null;
    let unsubResources = null;
    let unsubPhotos = null;

    // ============================
    // COLLECTION PATHS
    // ============================
    // Admin-managed:
    //   services/{serviceId}
    //   addons/{addonId}
    // Shared:
    //   resources/{id}   (admin write, reps read)
    // Per-user:
    //   pins (collection) documents include repUid
    //   quotes (collection) documents include repUid
    //   photos (collection) documents include repUid
    // Roles:
    //   users/{uid} includes role: 'admin' | 'rep'

    // ============================
    // AUTH + ROLE
    // ============================
    async function resolveRole(user){
      if(!user) return 'rep';
      if(ADMIN_UIDS.includes(user.uid)) return 'admin';
      try{
        const snap = await getDoc(doc(db, 'users', user.uid));
        const data = snap.exists() ? snap.data() : null;
        const role = data?.role;
        if(role==='admin' || role==='rep') return role;
      } catch {}
      return 'rep';
    }

    async function ensureUserDoc(user, role){
      if(!user) return;
      const refd = doc(db, 'users', user.uid);
      const snap = await getDoc(refd);
      if(!snap.exists()){
        await setDoc(refd, {
          email: user.email || null,
          role: role || 'rep',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
      } else {
        await setDoc(refd, { email: user.email || null, updatedAt: serverTimestamp() }, { merge:true });
      }
    }

    function setAuthUI(signedIn){
      $('viewLogin').classList.toggle('hidden', signedIn);
      $('viewApp').classList.toggle('hidden', !signedIn);
      $('btnLogout').classList.toggle('hidden', !signedIn);

      if(!signedIn){
        $('userLine').textContent = 'Not signed in';
        $('modePill').textContent = 'Rep View';
        document.querySelectorAll('.admin-only').forEach(el=>{ el.style.display='none'; });
        return;
      }
      $('userLine').textContent = `${state.user.email} ‚Ä¢ ${state.role.toUpperCase()}`;
      $('modePill').textContent = state.role==='admin' ? 'Admin View' : 'Rep View';
      document.querySelectorAll('.admin-only').forEach(el=>{
        el.style.display = (state.role==='admin') ? '' : 'none';
      });
    }

    // ============================
    // REALTIME SUBSCRIPTIONS
    // ============================
    function clearSubs(){
      [unsubPins, unsubServices, unsubAddons, unsubResources, unsubPhotos].forEach(fn=>{ try{ fn && fn(); } catch{} });
      unsubPins = unsubServices = unsubAddons = unsubResources = unsubPhotos = null;
    }

    function subscribeData(){
      if(!state.user) return;
      clearSubs();

      // Pins: reps see their own; admin sees all
      const pinsCol = collection(db, 'pins');
      const pinsQ = (state.role==='admin')
        ? query(pinsCol, orderBy('updatedAt','desc'))
        : query(pinsCol, where('repUid','==', state.user.uid), orderBy('updatedAt','desc'));

      unsubPins = onSnapshot(pinsQ, (snap)=>{
        state.pins = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        refreshPins();
        syncMarkers();
      }, (err)=>toast('Pins error', err.message));

      // Services + addons: everyone can read, admin writes
      unsubServices = onSnapshot(query(collection(db,'services'), orderBy('name','asc')), (snap)=>{
        state.services = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        refreshServiceDropdowns();
        if(state.role==='admin') refreshAdmin();
      }, (err)=>toast('Services error', err.message));

      unsubAddons = onSnapshot(query(collection(db,'addons'), orderBy('name','asc')), (snap)=>{
        state.addons = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        refreshServiceDropdowns();
        if(state.role==='admin') refreshAdmin();
      }, (err)=>toast('Add-ons error', err.message));

      unsubResources = onSnapshot(query(collection(db,'resources'), orderBy('title','asc')), (snap)=>{
        state.resources = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        refreshResources();
      }, (err)=>toast('Resources error', err.message));

      // Photos: reps see their own; admin sees all
      const photosCol = collection(db, 'photos');
      const photosQ = (state.role==='admin')
        ? query(photosCol, orderBy('createdAt','desc'))
        : query(photosCol, where('repUid','==', state.user.uid), orderBy('createdAt','desc'));

      unsubPhotos = onSnapshot(photosQ, (snap)=>{
        state.photos = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        refreshPhotos();
      }, (err)=>toast('Photos error', err.message));
    }

    // ============================
    // TABS
    // ============================
    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
      document.querySelectorAll('.tabpane').forEach(p=>p.classList.add('hidden'));
      $('tab-' + tab).classList.remove('hidden');

      const titles = { map:'Map / Leads', quote:'Quote Builder', photos:'Photos', resources:'Resources', admin:'Admin Panel' };
      $('panelTitle').textContent = titles[tab] || 'Field App';

      $('btnAddPin').style.display = tab==='map' ? '' : 'none';

      if(tab==='admin' && state.role!=='admin'){
        setTab('map');
        return;
      }
    }

    // ============================
    // MAP MARKERS
    // ============================
    function syncMarkers(){
      if(!map) return;
      const filter = $('filterStatus')?.value || '';
      const pins = filter ? state.pins.filter(p=>p.status===filter) : state.pins;

      const keep = new Set(pins.map(p=>p.id));
      // Remove markers that are no longer in view
      for(const [pinId, mk] of markers.entries()){
        if(!keep.has(pinId)){
          mk.setMap(null);
          markers.delete(pinId);
        }
      }

      // Add/update
      pins.forEach(p=>{
        const lat = Number(p.lat);
        const lng = Number(p.lng);
        if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const color = statusColor(p.status);
        if(!markers.has(p.id)){
          const mk = new google.maps.Marker({
            position: {lat, lng},
            map,
            title: p.address || 'Pin',
            icon: makeMarkerIcon(color)
          });
          mk.addListener('click', ()=>openPinModal(p, false));
          markers.set(p.id, mk);
        } else {
          const mk = markers.get(p.id);
          mk.setPosition({lat, lng});
          mk.setIcon(makeMarkerIcon(color));
        }
      });
    }

    async function geocodeAddressToLatLng(address){
      if(!geocoder) throw new Error('Geocoder not ready');
      const res = await geocoder.geocode({ address });
      const loc = res?.results?.[0]?.geometry?.location;
      if(!loc) throw new Error('Could not geocode address');
      return { lat: loc.lat(), lng: loc.lng() };
    }

    // ============================
    // PINS (FIRESTORE)
    // ============================
    function openPinModal(pin=null, allowEmpty=true){
      state.editingPinId = pin?.id || null;
      $('pinModalTitle').textContent = pin?.id ? 'Edit Pin' : 'Add Pin';
      $('btnPinDelete').style.display = pin?.id ? '' : 'none';

      $('pAddress').value = pin?.address || '';
      $('pStatus').value = pin?.status || 'New Lead';
      $('pName').value = pin?.customerName || '';
      $('pPhone').value = pin?.phone || '';
      $('pNotes').value = pin?.notes || '';

      $('pFollowDate').value = pin?.followDate || '';
      $('pFollowTime').value = pin?.followTime || '';

      $('pLat').value = (pin?.lat ?? '');
      $('pLng').value = (pin?.lng ?? '');

      $('pinModalBack').style.display = 'flex';

      // If lat/lng passed but no address, don‚Äôt force it
      if(!allowEmpty && !pin?.address){
        $('pAddress').value = '(no address)';
      }
    }

    function closePinModal(){
      $('pinModalBack').style.display = 'none';
      state.editingPinId = null;
    }

    async function savePin(){
      if(!state.user) return;

      let address = $('pAddress').value.trim();
      const status = $('pStatus').value;
      const customerName = $('pName').value.trim();
      const phone = $('pPhone').value.trim();
      const notes = $('pNotes').value.trim();
      const followDate = $('pFollowDate').value;
      const followTime = $('pFollowTime').value;

      let lat = Number($('pLat').value);
      let lng = Number($('pLng').value);

      // Try to geocode if missing lat/lng and address is reasonable
      if((!Number.isFinite(lat) || !Number.isFinite(lng)) && address && address !== '(no address)'){
        try{
          const g = await geocodeAddressToLatLng(address);
          lat = g.lat; lng = g.lng;
          $('pLat').value = lat;
          $('pLng').value = lng;
        } catch(e){
          // Not fatal
          toast('Geocode', 'Could not geocode address. You can still save the pin.');
        }
      }

      if(!address) address = '(no address)';

      const data = {
        address,
        status,
        customerName,
        phone,
        notes,
        followDate,
        followTime,
        lat: Number.isFinite(lat) ? lat : null,
        lng: Number.isFinite(lng) ? lng : null,
        repUid: state.user.uid,
        repEmail: state.user.email || null,
        updatedAt: serverTimestamp(),
      };

      try{
        if(state.editingPinId){
          await updateDoc(doc(db,'pins', state.editingPinId), data);
        } else {
          await addDoc(collection(db,'pins'), {
            ...data,
            createdAt: serverTimestamp(),
            quoteId: null
          });
        }
        closePinModal();
        toast('Saved', 'Pin saved.');
      } catch(e){
        toast('Save failed', e.message);
      }
    }

    async function deletePin(){
      if(!state.user || !state.editingPinId) return;
      if(!confirm('Delete this pin?')) return;
      try{
        await deleteDoc(doc(db,'pins', state.editingPinId));
        closePinModal();
        toast('Deleted', 'Pin deleted.');
      } catch(e){
        toast('Delete failed', e.message);
      }
    }

    function pinToQuote(){
      const pin = state.pins.find(p=>p.id===state.editingPinId);
      if(pin){
        $('qCustomer').value = pin.customerName || '';
        $('qPhone').value = pin.phone || '';
        $('qAddress').value = pin.address || '';
        state.quote.pinId = pin.id;
      }
      closePinModal();
      setTab('quote');
    }

    function refreshPins(){
      const filter = $('filterStatus')?.value || '';
      const pins = filter ? state.pins.filter(p=>p.status===filter) : state.pins;

      $('pinCount').textContent = `${pins.length} pins`;
      const el = $('pinList');
      el.innerHTML = '';

      if(pins.length===0){
        el.innerHTML = `<div class="hint">No pins yet. Tap <span class="kbd">Add Pin</span> to create your first lead.</div>`;
        return;
      }

      pins.forEach(p=>{
        const badge = `<span class="badge ${badgeClass(p.status)}">${escapeHtml(p.status)}</span>`;
        const follow = (p.followDate || p.followTime) ? ` ‚Ä¢ Follow-up: ${p.followDate || ''} ${p.followTime || ''}` : '';
        const meta = `${p.address || ''}${follow}`;
        const name = p.customerName ? `${p.customerName}` : 'Lead';
        const phone = p.phone ? ` ‚Ä¢ ${p.phone}` : '';
        const note = p.notes ? ` ‚Ä¢ ${p.notes}` : '';

        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(name)} ${badge}</div>
            <p class="meta">${escapeHtml(meta)}</p>
            <p class="meta">${escapeHtml(phone + note)}</p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" data-act="edit">Edit</button>
            <button class="btn primary" data-act="quote">Quote</button>
          </div>
        `;
        row.querySelector('[data-act="edit"]').onclick=()=>openPinModal(p, false);
        row.querySelector('[data-act="quote"]').onclick=()=>{ openPinModal(p, false); pinToQuote(); };
        el.appendChild(row);
      });
    }

    function csvSafe(v){
      const s = String(v ?? '');
      if(/[\",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
      return s;
    }

    function exportPins(){
      const pins = state.pins;
      const csv = [
        ['id','address','status','customerName','phone','notes','followDate','followTime','repEmail','lat','lng'].join(',')
      ].concat(pins.map(p=>[
        p.id, p.address, p.status, p.customerName, p.phone, p.notes, p.followDate, p.followTime, p.repEmail, p.lat, p.lng
      ].map(csvSafe).join(','))).join('\n');

      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='cgh_pins_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================
    // QUOTES
    // ============================
    function resetQuote(){
      state.quote.lines=[];
      state.quote.addons=[];
      state.quote.pinId = null;
      $('qCustomer').value='';
      $('qPhone').value='';
      $('qAddress').value='';
      refreshQuote();
    }

    function addServiceLine(){
      const svcId = $('svcSelect').value;
      const qty = Number($('svcQty').value);
      const svc = state.services.find(s=>s.id===svcId);
      if(!svc) return;
      if(!qty || qty<=0){ alert('Enter a quantity greater than 0.'); return; }

      const rate = Number(svc.rate);
      const min = Number(svc.min || 0);
      const raw = qty * rate;
      const total = Math.max(raw, min);

      state.quote.lines.push({
        id: uid(),
        svcId,
        name: svc.name,
        unit: svc.unit,
        rate,
        qty,
        min,
        raw,
        total
      });

      $('svcQty').value='';
      refreshQuote();
    }

    function addPresetAddon(){
      const id = $('addonSelect').value;
      const a = state.addons.find(x=>x.id===id);
      if(!a) return;
      const amt = Number($('addonAmt').value || a.amt || 0);
      state.quote.addons.push({id: uid(), name: a.name, amt});
      $('addonAmt').value='';
      refreshQuote();
    }

    function addCustomAddon(){
      const desc = $('customDesc').value.trim();
      const amt = Number($('customAmt').value);
      if(!desc){ alert('Add a description for the custom add-on.'); return; }
      if(!amt || amt<=0){ alert('Add an amount greater than 0.'); return; }
      state.quote.addons.push({id: uid(), name: desc, amt});
      $('customDesc').value='';
      $('customAmt').value='';
      refreshQuote();
    }

    function calcSubtotal(){
      const lines = state.quote.lines.reduce((s,l)=>s + Number(l.total||0), 0);
      const adds = state.quote.addons.reduce((s,a)=>s + Number(a.amt||0), 0);
      return lines + adds;
    }

    function refreshQuote(){
      const el = $('quoteLines');
      el.innerHTML='';

      if(state.quote.lines.length===0 && state.quote.addons.length===0){
        el.innerHTML = `<div class="hint">No line items yet. Add a service and optional add-ons.</div>`;
      }

      state.quote.lines.forEach(l=>{
        const row = document.createElement('div');
        row.className='item';
        const minNote = (l.raw < l.min) ? ` ‚Ä¢ min applied (${money(l.min)})` : '';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(l.name)} <span class="badge b-quoted">Service</span></div>
            <p class="meta">${l.qty} ${unitLabel(l.unit)} √ó ${money(l.rate)}${minNote}</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <strong>${money(l.total)}</strong>
            <button class="btn" title="Remove">‚úï</button>
          </div>
        `;
        row.querySelector('button').onclick=()=>{
          state.quote.lines = state.quote.lines.filter(x=>x.id!==l.id);
          refreshQuote();
        };
        el.appendChild(row);
      });

      state.quote.addons.forEach(a=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(a.name)} <span class="badge b-follow">Add-on</span></div>
            <p class="meta">Extra charge</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <strong>${money(a.amt)}</strong>
            <button class="btn" title="Remove">‚úï</button>
          </div>
        `;
        row.querySelector('button').onclick=()=>{
          state.quote.addons = state.quote.addons.filter(x=>x.id!==a.id);
          refreshQuote();
        };
        el.appendChild(row);
      });

      const subtotal = calcSubtotal();
      $('subTotal').textContent = money(subtotal);
      $('grandTotal').textContent = money(subtotal);
    }

    async function saveQuote(){
      if(!state.user) return;

      const customer = {
        name: $('qCustomer').value.trim(),
        phone: $('qPhone').value.trim(),
        address: $('qAddress').value.trim(),
      };

      if(!customer.address){ alert('Add an address for the quote.'); return; }
      if(state.quote.lines.length===0){ alert('Add at least one service line.'); return; }

      const total = calcSubtotal();

      try{
        const qref = await addDoc(collection(db,'quotes'), {
          customer,
          lines: state.quote.lines,
          addons: state.quote.addons,
          subtotal: total,
          total,
          status: 'Saved',
          repUid: state.user.uid,
          repEmail: state.user.email || null,
          pinId: state.quote.pinId || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        // link to pin if present
        if(state.quote.pinId){
          await updateDoc(doc(db,'pins', state.quote.pinId), {
            quoteId: qref.id,
            status: 'Quoted',
            updatedAt: serverTimestamp()
          });
        }

        toast('Quote saved', `Quote ID: ${qref.id}`);
      } catch(e){
        toast('Save failed', e.message);
      }
    }

    function computeDepositAmount(total){
      if(DEPOSIT_MODE==='flat') return Math.min(total, DEPOSIT_FLAT);
      return Math.round(total * DEPOSIT_PERCENT * 100) / 100;
    }

    async function startStripeCheckout(mode){
      const total = calcSubtotal();
      if(total<=0){ alert('Build a quote first.'); return; }

      const amount = (mode==='deposit') ? computeDepositAmount(total) : total;
      const description = (mode==='deposit') ? `CGH Deposit (${Math.round((amount/total)*100)}%)` : 'CGH Payment in Full';

      const payload = {
        mode,
        amount,
        currency: 'usd',
        description,
        metadata: {
          repEmail: state.user?.email || '',
          pinId: state.quote.pinId || '',
          total: total
        }
      };

      try{
        $('btnDeposit').innerHTML = '<span class="spinner"></span> Processing';
        $('btnPayFull').innerHTML = '<span class="spinner"></span> Processing';

        const res = await fetch(STRIPE_CREATE_SESSION_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data?.error || 'Stripe session failed');
        if(!data?.url) throw new Error('No checkout URL returned');
        window.location.href = data.url;
      } catch(e){
        toast('Stripe error', e.message);
      } finally {
        $('btnDeposit').textContent = 'Collect Deposit';
        $('btnPayFull').textContent = 'Pay in Full';
      }
    }

    // ============================
    // PHOTOS
    // ============================
    async function uploadPhoto(){
      if(!state.user) return;
      const f = $('photoFile').files?.[0];
      if(!f){ alert('Choose a file first.'); return; }

      const attach = $('photoAttach').value;
      const type = $('photoType').value;
      const notes = $('photoNotes').value.trim();

      const photoId = uid();
      const path = `photos/${state.user.uid}/${photoId}_${f.name}`;

      try{
        $('btnUploadPhoto').innerHTML = '<span class="spinner"></span> Uploading';

        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, f);
        const url = await getDownloadURL(storageRef);

        await addDoc(collection(db,'photos'), {
          repUid: state.user.uid,
          repEmail: state.user.email || null,
          attach,
          type,
          notes,
          filename: f.name,
          size: f.size,
          storagePath: path,
          url,
          createdAt: serverTimestamp()
        });

        $('photoFile').value='';
        $('photoNotes').value='';
        toast('Uploaded', 'Photo uploaded.');
      } catch(e){
        toast('Upload failed', e.message);
      } finally {
        $('btnUploadPhoto').textContent = 'Upload';
      }
    }

    async function clearPhotos(){
      if(state.role!=='admin'){
        alert('Admin only');
        return;
      }
      if(!confirm('Clear ALL photos (metadata) from Firestore? (This does not delete Storage files unless we add that)')) return;
      try{
        const snap = await getDocs(collection(db,'photos'));
        const dels = snap.docs.map(d=>deleteDoc(doc(db,'photos', d.id)));
        await Promise.all(dels);
        toast('Cleared', 'Photos metadata cleared.');
      } catch(e){
        toast('Clear failed', e.message);
      }
    }

    function refreshPhotos(){
      const el = $('photoList');
      el.innerHTML='';
      const photos = state.photos || [];
      if(photos.length===0){
        el.innerHTML = `<div class="hint">No uploads yet.</div>`;
        return;
      }
      photos.slice(0,12).forEach(p=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(p.filename || 'photo')} <span class="badge b-no">${escapeHtml(p.type || '')}</span></div>
            <p class="meta">${escapeHtml(p.attach || '')} ‚Ä¢ ${escapeHtml(p.notes || '')}</p>
            <p class="meta">${p.url ? `<a href="${p.url}" target="_blank" rel="noreferrer">Open</a>` : ''}</p>
          </div>
          <div class="small">${Math.round((p.size||0)/1024)} KB</div>
        `;
        el.appendChild(row);
      });
    }

    // ============================
    // RESOURCES
    // ============================
    async function addResource(){
      if(!state.user) return;
      const cat = $('resCat').value;
      const title = $('resTitle').value.trim();
      const body = $('resBody').value.trim();
      if(!title || !body){ alert('Add both title and content/link.'); return; }

      try{
        await addDoc(collection(db,'resources'), {
          cat,
          title,
          body,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          createdBy: state.user.email || null
        });
        $('resTitle').value='';
        $('resBody').value='';
        toast('Added', 'Resource added.');
      } catch(e){
        toast('Add failed', e.message);
      }
    }

    async function clearResources(){
      if(state.role!=='admin'){
        alert('Admin only');
        return;
      }
      if(!confirm('Clear resources library?')) return;
      try{
        const snap = await getDocs(collection(db,'resources'));
        await Promise.all(snap.docs.map(d=>deleteDoc(doc(db,'resources', d.id))));
        toast('Cleared', 'Resources cleared.');
      } catch(e){
        toast('Clear failed', e.message);
      }
    }

    function refreshResources(){
      const res = state.resources || [];
      const el = $('resList');
      el.innerHTML='';
      if(res.length===0){ el.innerHTML = `<div class="hint">No resources yet.</div>`; return; }
      res.slice(0,20).forEach(r=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(r.title)} <span class="badge b-new">${escapeHtml(r.cat)}</span></div>
            <p class="meta">${escapeHtml(r.body)}</p>
          </div>
          ${state.role==='admin' ? '<button class="btn" title="Remove">‚úï</button>' : '<span></span>'}
        `;
        if(state.role==='admin'){
          row.querySelector('button').onclick=async()=>{
            if(!confirm('Remove this resource?')) return;
            try{
              await deleteDoc(doc(db,'resources', r.id));
              toast('Removed', 'Resource removed.');
            } catch(e){
              toast('Remove failed', e.message);
            }
          };
        }
        el.appendChild(row);
      });
    }

    // ============================
    // ADMIN (SERVICES + ADDONS)
    // ============================
    function slug(s){
      return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    }

    function refreshAdmin(){
      if(state.role!=='admin') return;

      const services = state.services || [];
      const addons = state.addons || [];

      const svcEl = $('svcAdminList');
      svcEl.innerHTML='';
      services.forEach(s=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(s.name)} <span class="badge b-quoted">${unitLabel(s.unit)}</span></div>
            <p class="meta">Rate: ${money(s.rate)} / ${unitLabel(s.unit)} ‚Ä¢ Min: ${money(s.min||0)}</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" data-act="edit">Edit</button>
            <button class="btn" data-act="del">‚úï</button>
          </div>
        `;
        row.querySelector('[data-act="edit"]').onclick=()=>{
          $('aSvcName').value = s.name;
          $('aSvcUnit').value = s.unit;
          $('aSvcRate').value = s.rate;
          $('aSvcMin').value = s.min;
          $('aSvcName').dataset.editId = s.id;
        };
        row.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm('Delete this service?')) return;
          try{
            await deleteDoc(doc(db,'services', s.id));
            toast('Deleted', 'Service deleted.');
          } catch(e){
            toast('Delete failed', e.message);
          }
        };
        svcEl.appendChild(row);
      });

      const addEl = $('addonAdminList');
      addEl.innerHTML='';
      addons.forEach(a=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="left">
            <div class="name">${escapeHtml(a.name)} <span class="badge b-follow">Add-on</span></div>
            <p class="meta">Amount: ${money(a.amt)}</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" data-act="edit">Edit</button>
            <button class="btn" data-act="del">‚úï</button>
          </div>
        `;
        row.querySelector('[data-act="edit"]').onclick=()=>{
          $('aAddName').value = a.name;
          $('aAddAmt').value = a.amt;
          $('aAddName').dataset.editId = a.id;
        };
        row.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm('Delete this add-on?')) return;
          try{
            await deleteDoc(doc(db,'addons', a.id));
            toast('Deleted', 'Add-on deleted.');
          } catch(e){
            toast('Delete failed', e.message);
          }
        };
        addEl.appendChild(row);
      });

      refreshServiceDropdowns();
    }

    async function adminAddOrUpdateService(){
      if(state.role!=='admin') return;
      const name = $('aSvcName').value.trim();
      const unit = $('aSvcUnit').value;
      const rate = Number($('aSvcRate').value);
      const min = Number($('aSvcMin').value || 0);
      if(!name){ alert('Service name required'); return; }
      if(!rate || rate<=0){ alert('Rate must be > 0'); return; }

      const editId = $('aSvcName').dataset.editId;
      const id = editId || slug(name);

      try{
        await setDoc(doc(db,'services', id), {
          name, unit, rate, min,
          updatedAt: serverTimestamp()
        }, { merge:true });

        $('aSvcName').value='';
        $('aSvcRate').value='';
        $('aSvcMin').value='';
        $('aSvcName').dataset.editId='';

        toast('Saved', 'Service saved.');
      } catch(e){
        toast('Save failed', e.message);
      }
    }

    async function adminResetServices(){
      if(state.role!=='admin') return;
      if(!confirm('Reset services to defaults?')) return;

      const defaults = [
        { id:'house_wash', name:'House Wash', unit:'sqft', rate:0.18, min:249 },
        { id:'drive_surface', name:'Driveway Surface Clean', unit:'sqft', rate:0.22, min:199 },
        { id:'roof_wash', name:'Roof Wash', unit:'sqft', rate:0.40, min:399 },
        { id:'fence_clean', name:'Fence Cleaning', unit:'linear_ft', rate:2.50, min:199 },
        { id:'gutter_clean', name:'Gutter Cleaning', unit:'linear_ft', rate:1.85, min:149 },
        { id:'window_clean', name:'Window Cleaning', unit:'each', rate:6.50, min:149 },
      ];

      try{
        // wipe existing
        const snap = await getDocs(collection(db,'services'));
        await Promise.all(snap.docs.map(d=>deleteDoc(doc(db,'services', d.id))));
        // add defaults
        await Promise.all(defaults.map(s=>setDoc(doc(db,'services', s.id), {
          name:s.name, unit:s.unit, rate:s.rate, min:s.min,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        })));
        toast('Reset', 'Services reset to defaults.');
      } catch(e){
        toast('Reset failed', e.message);
      }
    }

    async function adminAddOrUpdateAddon(){
      if(state.role!=='admin') return;
      const name = $('aAddName').value.trim();
      const amt = Number($('aAddAmt').value);
      if(!name){ alert('Add-on name required'); return; }
      if(!amt || amt<=0){ alert('Amount must be > 0'); return; }

      const editId = $('aAddName').dataset.editId;
      const id = editId || slug(name);

      try{
        await setDoc(doc(db,'addons', id), {
          name, amt,
          updatedAt: serverTimestamp()
        }, { merge:true });

        $('aAddName').value='';
        $('aAddAmt').value='';
        $('aAddName').dataset.editId='';

        toast('Saved', 'Add-on saved.');
      } catch(e){
        toast('Save failed', e.message);
      }
    }

    async function adminResetAddons(){
      if(state.role!=='admin') return;
      if(!confirm('Reset add-ons to defaults?')) return;

      const defaults = [
        { id:'heavy', name:'Heavy Buildup', amt:75 },
        { id:'rust', name:'Rust Treatment', amt:95 },
        { id:'travel', name:'Travel / Mobilization', amt:50 },
        { id:'afterhours', name:'After-hours / Weekend', amt:100 },
      ];

      try{
        const snap = await getDocs(collection(db,'addons'));
        await Promise.all(snap.docs.map(d=>deleteDoc(doc(db,'addons', d.id))));
        await Promise.all(defaults.map(a=>setDoc(doc(db,'addons', a.id), {
          name:a.name, amt:a.amt,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        })));
        toast('Reset', 'Add-ons reset to defaults.');
      } catch(e){
        toast('Reset failed', e.message);
      }
    }

    function refreshServiceDropdowns(){
      const services = state.services || [];
      const addons = state.addons || [];

      $('svcSelect').innerHTML = services.map(s=>
        `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} ‚Äî ${money(s.rate)}/${unitLabel(s.unit)} (min ${money(s.min||0)})</option>`
      ).join('');

      $('addonSelect').innerHTML = addons.map(a=>
        `<option value="${escapeHtml(a.id)}">${escapeHtml(a.name)} ‚Äî ${money(a.amt)}</option>`
      ).join('');

      $('addonSelect').onchange = ()=>{
        const a = (state.addons || []).find(x=>x.id===$('addonSelect').value);
        $('addonAmt').value = a?.amt ?? '';
      };

      const firstAddon = addons[0];
      if(firstAddon && !$('addonAmt').value){
        $('addonAmt').value = firstAddon.amt;
      }
    }

    // ============================
    // QUICK FILTERS
    // ============================
    function quickFilter(status){
      $('filterStatus').value = status || '';
      refreshPins();
      syncMarkers();
    }

    // ============================
    // SETUP MODAL
    // ============================
    function openSetup(){ $('setupBack').style.display='flex'; }
    function closeSetup(){ $('setupBack').style.display='none'; }

    // ============================
    // WIRE UI
    // ============================
    function setLoginState(msg){ $('loginState').textContent = msg; }

    async function doLogin(){
      const email = $('loginEmail').value.trim();
      const pass = $('loginPass').value;
      if(!email || !pass){ alert('Enter email + password'); return; }

      try{
        setLoginState('Signing in‚Ä¶');
        await signInWithEmailAndPassword(auth, email, pass);
        setLoginState('');
      } catch(e){
        setLoginState('');
        toast('Login failed', e.message);
      }
    }

    async function doForgot(){
      const email = $('loginEmail').value.trim();
      if(!email){ alert('Enter your email first'); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        toast('Sent', 'Password reset email sent.');
      } catch(e){
        toast('Reset failed', e.message);
      }
    }

    async function doLogout(){
      try{ await signOut(auth); } catch(e){ toast('Logout failed', e.message); }
    }

    function wire(){
      $('btnLogin').onclick = doLogin;
      $('btnForgot').onclick = doForgot;
      $('btnLogout').onclick = doLogout;

      document.querySelectorAll('.tab').forEach(t=>{ t.onclick = ()=>setTab(t.dataset.tab); });

      $('btnAddPin').onclick = ()=>openPinModal(null, true);
      $('btnPinClose').onclick = closePinModal;
      $('pinModalBack').onclick = (e)=>{ if(e.target.id==='pinModalBack') closePinModal(); };

      $('btnPinSave').onclick = savePin;
      $('btnPinDelete').onclick = deletePin;
      $('btnPinToQuote').onclick = ()=>{ if(!state.editingPinId) savePin(); pinToQuote(); };

      $('filterStatus').onchange = ()=>{ refreshPins(); syncMarkers(); };
      $('btnExport').onclick = exportPins;

      $('btnAddService').onclick = addServiceLine;
      $('btnClearQuote').onclick = resetQuote;
      $('btnAddAddon').onclick = addPresetAddon;
      $('btnAddCustom').onclick = addCustomAddon;
      $('btnSaveQuote').onclick = saveQuote;
      $('btnDeposit').onclick = ()=>startStripeCheckout('deposit');
      $('btnPayFull').onclick = ()=>startStripeCheckout('full');

      $('btnUploadPhoto').onclick = uploadPhoto;
      $('btnClearPhotos').onclick = clearPhotos;

      $('btnAddRes').onclick = addResource;
      $('btnClearRes').onclick = clearResources;

      $('btnAdminAddSvc').onclick = adminAddOrUpdateService;
      $('btnAdminResetSvc').onclick = adminResetServices;
      $('btnAdminAddAddon').onclick = adminAddOrUpdateAddon;
      $('btnAdminResetAddon').onclick = adminResetAddons;

      $('btnQuickNew').onclick = ()=>quickFilter('New Lead');
      $('btnQuickFollow').onclick = ()=>quickFilter('Follow-Up Needed');
      $('btnQuickBooked').onclick = ()=>quickFilter('Booked');

      $('btnOpenSetup').onclick = openSetup;
      $('btnSetupClose').onclick = closeSetup;
      $('setupBack').onclick = (e)=>{ if(e.target.id==='setupBack') closeSetup(); };
    }

    // ============================
    // BOOT
    // ============================
    wire();

    // Auth listener
    onAuthStateChanged(auth, async(user)=>{
      try{
        if(!user){
          state.user = null;
          state.role = 'rep';
          clearSubs();
          setAuthUI(false);
          $('userLine').textContent = 'Not signed in';
          return;
        }

        state.user = user;
        state.role = await resolveRole(user);
        await ensureUserDoc(user, state.role);

        setAuthUI(true);
        subscribeData();

        // Init map once
        if(!map){
          try{
            await initMap();
            syncMarkers();
          } catch(e){
            toast('Maps not ready', e.message);
          }
        }

        // Default tab
        setTab('map');

      } catch(e){
        toast('Init error', e.message);
      }
    });

  </script>
</body>
</html>
